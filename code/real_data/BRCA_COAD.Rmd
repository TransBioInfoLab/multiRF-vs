---
title: "Real Data Analysis"
output:
  html_document:
    highlight: pygments
    theme: yeti
    toc: true
    number_sections: true
    df_print: paged
    code_download: false
    toc_float:
      collapsed: yes
    toc_depth: 3
editor_options:
  chunk_output_type: inline    
---

```{r setup, include=FALSE}
# Set global chunk options: show code by default
knitr::opts_chunk$set(echo = TRUE)

# Define base directory for functions and source all R scripts in it
dir.base <- "."
script <- list.files(
  path = file.path(dir.base, "function"),      # path to functions
  pattern = "[.]R$",                            # match R scripts
  full.names = TRUE,                              # return full file paths
  recursive = TRUE                                # search subdirectories
)
for (f in script) source(f)                       # source each function file

# Define path to processed data folder
dir.data <- file.path(dir.base, "$data path$")
```

```{r message = FALSE, warning = FALSE}
# Load required libraries for analysis and plotting
library(tidyverse)    # data manipulation and visualization
library(pheatmap)     # heatmap plotting
library(ggpubr)       # publication-ready ggplots
library(survival)     # survival analysis functions
library(survminer)    # survival curves visualization
library(ggvenn)       # Venn diagrams
library(clusterProfiler)  # enrichment analysis
library(msigdbr)      # MSigDB gene sets
library(mixOmics)     # multivariate analysis for omics
library(patchwork)    # combine ggplots
```

# TCGA-BRCA

## Load data
```{r}
# Specify cohort name and set paths for raw and processed data
cohort <- "BRCA"
dir.data.raw <- file.path(dir.data, cohort, "raw/")          # directory of raw omics data
dir.data.processed <- file.path(dir.data, cohort, "processed/")# directory of cleaned/processed data

# Define folder to save analysis results
dir.results <- file.path(dir.base, "results/real_data", cohort)

# Load precomputed top 2000 features for each omics type
load(file.path(dir.data.processed, "BRCA_three_omics_top_2000.rda"))
```

## Sensitivity analysis
```{r eval = FALSE}
# Run sensitivity analysis by varying random seed (rep = 10 repeats)
size <- run_different_seed(
  tcga_brca,                             # list of omics matrices
  status = tcga_brca_clinical$OS,        # survival status vector
  time = tcga_brca_clinical$OS.time,     # survival time vector
  rep = 10                                # number of seeds to test
)
```

```{r eval = FALSE}
# Save sensitivity analysis results to CSV and RDA
write_csv(size, file.path(dir.results, "BRCA_sens_analysis.csv"))
save(size, file = file.path(dir.results, "BRCA_sens_analysis.rda"))
```

### Model Size
```{r echo = FALSE}
# Load previously saved sensitivity analysis
load(file.path(dir.results, "BRCA_sens_analysis.rda"))

# Reshape 'size' for plotting: long format with columns 'Data' and 'Size'
size_long <- pivot_longer(
  size,
  values_to = "Size",
  names_to = "Data",
  cols = c("gene", "methy", "mirna")
)
# Rename Data values for readability
size_long$Data <- ifelse(
  size_long$Data == "gene", "Gene",
  ifelse(size_long$Data == "methy", "Methyl", "miRNA")
)

# Generate boxplot of model size by omics type and method
g1_brca <- ggboxplot(
  size_long,
  x = "Data", y = "Size",                     # x-axis: omics, y-axis: number of selected features
  ylab = "Model Size", xlab = "Omics",        # axis labels
  fill = "method",                              # color by MRF-IMD method variant
  palette = "jco",                              # color palette
  title = "TCGA-BRCA"                           # plot title
) +
  theme_bw() +                                    # white background theme
  theme(
    legend.title = element_blank(),               # remove legend title
    legend.position = "bottom"                   # place legend below
  ) +
  scale_fill_discrete(
    labels = c("MRF-IMD-filter", "MRF-IMD-mixture", "MRF-IMD-trans")
  ) +
  geom_vline(
    xintercept = c(1.5, 2.5),                     # vertical lines between categories
    linetype = "dashed", color = "grey30"
  )
# Display the plot
g1_brca
```

```{r echo = FALSE}
# Prepare data for variable selection consistency analysis
size2 <- size %>%
  mutate(run = paste(method, seed, sep = "_"))        # unique run ID combining method and seed

# Extract selected gene names per run into a named list
sel_genes <- size2 %>%
  transmute(run, genes = map(var_selected, ~ paste0("gene_", .x[[1]]))) %>%
  { set_names(.$genes, .$run) }

# Extract selected methylation sites per run
sel_methy <- size2 %>%
  transmute(run, methy = map(var_selected, ~ paste0("methy_", .x[[2]]))) %>%
  { set_names(.$methy, .$run) }

# Extract selected miRNAs per run
sel_mirna <- size2 %>%
  transmute(run, mirna = map(var_selected, ~ paste0("mirna_", .x[[3]]))) %>%
  { set_names(.$mirna, .$run) }

# Summarize model size and log-rank p-values by method
size_summ <- size %>% 
  group_by(method) %>% 
  summarise_at(
    vars(gene, methy, mirna, logrank_p),
    list(mean = mean, sd = sd, median = median)
  ) %>%
  mutate(
    Method = method,
    Gene = paste0(round(gene_mean, 0), " (", round(gene_sd, 2), ")"),
    Methyl = paste0(round(methy_mean, 0), " (", round(methy_sd, 2), ")"),
    miRNA = paste0(round(mirna_mean, 0), " (", round(mirna_sd, 2), ")"),
    "Median logrank -log10(p)" = round(-log10(logrank_p_median), 2),
    .keep = "none"                     # drop intermediate columns
  )
``` 

### Overlap Index

```{r echo = FALSE}
# Function to compute pairwise Overlap index matrix for a list of selected sets
overlap_mat_fn <- function(sel_sets) {
  runs <- names(sel_sets)
  n    <- length(runs)
  ol_mat <- matrix(NA, nrow = n, ncol = n,
                    dimnames = list(runs, runs))
  for (i in seq_len(n)) {
    for (j in seq_len(n)) {
      ol_mat[i, j] <- overlap(sel_sets[[runs[i]]],
                               sel_sets[[runs[j]]])
    }
  }
  ol_mat
}

# Compute Overlap matrices for each omics type
overlap_mat_gene  <- overlap_mat_fn(sel_genes)
overlap_mat_methy <- overlap_mat_fn(sel_methy)
overlap_mat_mirna <- overlap_mat_fn(sel_mirna)
# Combine into named list
overlap_list <- list(
  gene = overlap_mat_gene,
  methy = overlap_mat_methy,
  mirna = overlap_mat_mirna
)

# Convert matrices to long data frame of overlaps between runs
library(plyr)  # for ldply

df_overlap <- plyr::ldply(
  names(overlap_list),
  .fun = function(ls) {
    tbl <- as.table(overlap_list[[ls]])
    df_overlap <- as.data.frame(tbl) %>%
      rename(Run1 = Var1, Run2 = Var2, Overlap = Freq) %>%
      mutate(
        Method1 = sub("_.*", "", Run1),
        Method2 = sub("_.*", "", Run2)
      ) %>%
      filter(Method1 == Method2 & Run1 != Run2)  # keep only same-method comparisons
    df_overlap %>% mutate(Method = Method1, Data = ls)
  }
)

# Summarize overlaps by method and data type with 95% CI
ol_summary <- df_overlap %>%
  group_by(Method, Data) %>%
  summarise(
    mean_O  = mean(Overlap),
    sd_O    = sd(Overlap),
    n_pairs = n(),
    CI_low  = mean_O + qt(0.025, n_pairs - 1) * sd_O / sqrt(n_pairs),
    CI_high = mean_O + qt(0.975, n_pairs - 1) * sd_O / sqrt(n_pairs)
  ) %>%
  mutate(
    Overlap = paste0(round(mean_O, 2), " (", 
                     round(CI_low,  2), ",", 
                     round(CI_high, 2), ")"),
    .keep = "none"  # keep only summary columns
  )

# Join model size summary with overlap index summary into final data frame
df_brca <- left_join(size_summ, ol_summary, by = c("Method" = "Method"))
```

```{r echo = FALSE}
# Recode Data labels for the overlap boxplot
df_overlap$Data <- ifelse(df_overlap$Data == "gene", "Gene",
                          ifelse(df_overlap$Data == "methy", "Methyl", "miRNA"))
# Create boxplot of Jaccard overlap coefficients by omics and method
g2_brca <- ggboxplot(
  df_overlap,
  x = "Data", y = "Overlap",                    # x-axis: omics, y-axis: overlap coefficient
  ylab = "Overlap Coefficient", xlab = "Omics",
  fill = "Method1", palette = "jco"
) +
  theme_bw() +
  ylim(c(0, 1)) +                                    # restrict y-axis to [0,1]
  theme(legend.title = element_blank(), legend.position = "bottom") +
  scale_fill_discrete(labels = c("MRF-IMD-filter", "MRF-IMD-mixture", "MRF-IMD-trans")) +
  geom_vline(xintercept = c(1.5, 2.5), linetype = "dashed", color = "grey30")
# Display the overlap boxplot
g2_brca
```

```{r echo = FALSE}
# Combine model size and overlap plots into one figure with shared legend
combined_plot <- g1_brca + g2_brca +
  plot_layout(guides = "collect") &
  theme(legend.position = "top")
# Display combined sensitivity analysis plot
combined_plot
# Save combined plot to PDF for reporting
ggsave(
  filename = file.path(dir.results, "BRCA_sens_boxplot.pdf"),
  plot = combined_plot,
  width = 8, height = 4
)
```

## Train Models

### MRF-IMD-mixture
```{r eval = FALSE}
# Initialize MRF-IMD mixture model with fixed seed and block connectivity
seed <- 133
mod_brca <- mrf3_init(
  tcga_brca, seed = seed, scale = FALSE,
  connect_list = list(c("gene", "methy"), c("mirna", "methy"))
)
# Apply variable selection via the mixture variant of MRF-IMD
mod_brca_vs <- mrf3_vs(mod_brca, dat.list = tcga_brca, method = "mixture")
# Recorded feature counts: gene = 102, methyl = 141, miRNA = 22
```

### SPLS, PMDCCA, RGCCA
```{r}
# Sparse PLS (SPLS) with pre-specified feature counts per block and components
mod_spls <- mixOmics::block.spls(
  X = tcga_brca,
  indY = 3,
  ncomp = 10,
  keepX = list(
    gene = rep(102, 5),
    methy = rep(141, 5),
    mirna = rep(22, 5)
  )
)

# Penalized Multi-CCA (PMDCCA) for multi-block correlation
mod_pmd <- PMA::MultiCCA(
  tcga_brca,
  ncomponents = 5
)

# Define adjacency matrix for RGCCA (gene<->methy and mirna<->methy)
connection <- diag(0, 3)
connection[1,2] <- connection[2,1] <- 1
connection[2,3] <- connection[3,2] <- 1
# Sparse RGCCA with one component per block
mod_rgcca <- rgcca(
  tcga_brca,
  connection = connection,
  ncomp = 5,
  sparsity = 0.1
)
```

```{r eval = FALSE}
# Save all model objects to RDA for downstream analyses	
save(
  mod_brca,
  mod_brca_vs,
  mod_spls,
  mod_pmd,
  mod_rgcca,
  file = file.path(dir.results, "BRCA_MRF_mod.rda")
)
```

## Pathway analysis

### MRF-IMD-mixture ORA
```{r echo = FALSE}
# Load mixture model outputs for ORA\load(file.path(dir.results, "BRCA_MRF_mod.rda"))
# Plot feature weights across blocks for visualization
g3_brca <- plot_weights(mod_brca_vs$weights, labels = c("Gene", "Methyl", "miRNA"))
g3_brca
```

```{r eval = FALSE}
# Over-Representation Analysis (ORA) for canonical (C2), Hallmark (H), and GO BP (C5)
ora_results_c2cp <- ORA(colnames(mod_brca_vs$dat.list$gene), pathway = "c2.cp", minGSSize = 2, maxGSSize = 1000)
ora_results_h    <- ORA(colnames(mod_brca_vs$dat.list$gene), pathway = "H",    minGSSize = 2, maxGSSize = 1000)
ora_results_go   <- ORA(colnames(mod_brca_vs$dat.list$gene), pathway = "c5.bp", minGSSize = 2, maxGSSize = 1000)
```

```{r eval = FALSE, echo = FALSE}
# Combine ORA results and filter for significance
results <- bind_rows(
  data.frame(ora_results_c2cp@result, category = "Canonical"),
  data.frame(ora_results_go@result,   category = "GO"),
  data.frame(ora_results_h@result,    category = "Hallmark")
)
results_sig <- filter(results, p.adjust < 0.05)

# Export ORA tables
write_csv(results,     file.path(dir.results, "BRCA_pathway_analysis.csv"))
write_csv(results_sig, file.path(dir.results, "BRCA_pathway_analysis_sig_results.csv"))
```

```{r fig.height=8, fig.width=15, echo=FALSE}
# Visualize pathway enrichment across gene sets
df_pathway <- read_csv(file.path(dir.results, "BRCA_pathway_analysis.csv"), show_col_types = FALSE)
g4_brca <- plot_pathway(df_pathway, ylim = 1e-9, padj = 0.05) + ggtitle("TCGA-BRCA")
g4_brca
```

### Comparative ORA and Venn diagram
```{r eval = FALSE}
# ORA for SPLS, PMDCCA, RGCCA (similar to above, code omitted)
# Save each method's results to CSV under distinct filenames
```

```{r fig.width=12, fig.height=12}
# Read significant ORA IDs for each method and plot Venn diagram
df_mrf   <- read_csv(file.path(dir.results, "BRCA_pathway_analysis_sig_results.csv"), show_col_types = FALSE)
df_spls  <- read_csv(file.path(dir.results, "BRCA_pathway_analysis_sig_results_spls.csv"), show_col_types = FALSE)
df_pmd   <- read_csv(file.path(dir.results, "BRCA_pathway_analysis_sig_results_pmd.csv"), show_col_types = FALSE)
df_rgcca <- read_csv(file.path(dir.results, "BRCA_pathway_analysis_sig_results_rgcca.csv"), show_col_types = FALSE)

ggvenn::ggvenn(
  list(
    "MRF-IMD" = df_mrf$ID,
    "SPLS"    = df_spls$ID,
    "PMDCCA"  = df_pmd$ID,
    "RGCCA"   = df_rgcca$ID
  )
) + ggtitle("TCGA-BRCA ORA overlap")
# Save Venn plot for reporting
ggsave(file.path(dir.results, "BRCA_venn_plot.pdf"), width = 12, height = 10)
```

## Survival analysis and KM plot

```{r eval = F}
nmf_mod <- IntNMF::nmf.mnnals(
  tcga_brca %>% purrr::map(., ~as.matrix(.)), 2
)

dat_pos_spls <- purrr::map(
    mod_spls$variates, ~{
      if(!all(. > 0)) {
        m <- abs(min(.))
        . <- pmax(. + m, 0)
        as.matrix(./max(.))
      }
    }
  )

dat_pos_spls2 <- plyr::llply(
  c("gene", "methy", "mirna"),
  .fun = function(data) {
    tcga_brca[[data]][,mod_spls$loadings[[data]][,1] != 0] %>% as.matrix
  }
)
names(dat_pos_spls2) <- c("gene", "methy", "mirna")

nmf_mod_spls <- IntNMF::nmf.mnnals(
  dat_pos_spls, 2
)

nmf_mod_spls2 <- IntNMF::nmf.mnnals(
  dat_pos_spls2, 2
)

dat_pos_pmd <- plyr::llply(
  c("gene", "methy", "mirna"),
  .fun = function(data) {
    if(data == "gene") i <- 1
    if(data == "methy") i <- 2
    if(data == "mirna") i <- 3
    d <- as.matrix(tcga_brca[[data]]) %*% mod_pmd$ws[[i]]
    m <- abs(min(d))
    d <- pmax(d + m, 0)
    as.matrix(d/max(d))
  }
)
names(dat_pos_pmd) <- c("gene", "methy", "mirna")

dat_pos_pmd2 <- plyr::llply(
  c("gene", "methy", "mirna"),
  .fun = function(data) {
    if(data == "gene") i <- 1
    if(data == "methy") i <- 2
    if(data == "mirna") i <- 3
    tcga_brca[[data]][,mod_pmd$ws[[i]][,1] != 0] %>% as.matrix
  }
)
names(dat_pos_spls2) <- c("gene", "methy", "mirna")

nmf_mod_pmd <- IntNMF::nmf.mnnals(
  dat_pos_pmd, 2
)

nmf_mod_pmd2 <- IntNMF::nmf.mnnals(
  dat_pos_pmd2, 2
)

dat_pos_rgcca <- purrr::map(
    mod_rgcca$Y, ~{
      if(!all(. > 0)) {
        m <- abs(min(.))
        . <- pmax(. + m, 0)
        as.matrix(./max(.))
      }
    }
  )

dat_pos_rgcca2 <- plyr::llply(
  c("gene", "methy", "mirna"),
  .fun = function(data) {
    tcga_brca[[data]][,mod_rgcca$a[[data]][,1] != 0] %>% as.matrix
  }
)
names(dat_pos_rgcca2) <- c("gene", "methy", "mirna")

nmf_mod_rgcca <- IntNMF::nmf.mnnals(
  dat_pos_rgcca, 2
)

nmf_mod_rgcca2 <- IntNMF::nmf.mnnals(
  dat_pos_rgcca2, 2
)

nmf_mod_mrf <- IntNMF::nmf.mnnals(
  mod_brca_vs$dat.list %>% purrr::map(., ~as.matrix(.)), 2
)

save(nmf_mod, 
     nmf_mod_spls, nmf_mod_spls2, 
     nmf_mod_pmd, nmf_mod_pmd2, 
     dat_pos_rgcca, dat_pos_rgcca2, 
     nmf_mod_mrf, file = file.path(dir.results, "NMF_all_var_spls_mod.rda"))
```

```{r fig.width=16, fig.height=6}
load(file.path(dir.results, "NMF_all_var_spls_mod.rda"))
k1 <- KM_plot(factor(nmf_mod$clusters), "OS.time", "OS", tcga_brca_clinical, title = "All Variables")
k2 <- KM_plot(factor(nmf_mod_spls$clusters), "OS.time", "OS", tcga_brca_clinical,
              title = "SPLS First 5 Components") 
k3 <- KM_plot(factor(nmf_mod_mrf$clusters), "OS.time", "OS", 
              tcga_brca_clinical, title = "MRF-IMD Selected Variables") 
g7_brca <- k1$plot + k2$plot + k3$plot + 
  plot_layout(ncol = 3) + 
  plot_annotation(title = "TCGA-BRCA",
                  theme =  theme(plot.title = element_text(face = "bold", size = 14)))
g7_brca
```

```{r}
logrank_p <- function(clusters, time, status) {
  surv_obj <- Surv(time, status)
  lr       <- survdiff(surv_obj ~ factor(clusters))
  1 - pchisq(lr$chisq, df = length(lr$n) - 1)
}

logrank_p_df <- plyr::ldply(
  c("All", "SPLS", "PMDCCA", "RGCCA", "MRF-IMD"),
  .fun = function(method) {
    if (method == "All") {
      return(data.frame(
        Method    = "all",
        logrank_p = logrank_p(
          nmf_mod$clusters,
          tcga_brca_clinical$OS.time,
          tcga_brca_clinical$OS
        )
      ))
    } else if (method == "SPLS") {
      return(data.frame(
        Method    = c("SPLS - 5 comps", "SPLS - selected variables"),
        logrank_p = c(
          logrank_p(
            nmf_mod_spls$clusters,
            tcga_brca_clinical$OS.time,
            tcga_brca_clinical$OS
          ),
          logrank_p(
            nmf_mod_spls2$clusters,
            tcga_brca_clinical$OS.time,
            tcga_brca_clinical$OS
          )
        )
      ))
    } else if (method == "PMDCCA") {
      return(data.frame(
        Method    = c("PMDCCA - 5 comps", "PMDCCA - selected variables"),
        logrank_p = c(
          logrank_p(
            nmf_mod_pmd$clusters,
            tcga_brca_clinical$OS.time,
            tcga_brca_clinical$OS
          ),
          logrank_p(
            nmf_mod_pmd2$clusters,
            tcga_brca_clinical$OS.time,
            tcga_brca_clinical$OS
          )
        )
      ))
    } else if (method == "RGCCA") {
      return(data.frame(
        Method    = c("RGCCA - 5 comps", "RGCCA - selected variables"),
        logrank_p = c(
          logrank_p(
            nmf_mod_rgcca$clusters,
            tcga_brca_clinical$OS.time,
            tcga_brca_clinical$OS
          ),
          logrank_p(
            nmf_mod_rgcca2$clusters,
            tcga_brca_clinical$OS.time,
            tcga_brca_clinical$OS
          )
        )
      ))
    } else if (method == "MRF-IMD") {
      return(data.frame(
        Method    = paste0("MRF-IMD-",size_summ$Method),
        logrank_p = 10^(-size_summ$`Median logrank -log10(p)`)
        )
      )
    } else {
      stop("Unknown method: ", method)
    }
  }
)
logrank_p_df
```

# TCGA-COAD

## Load data

```{r}
# Data folder
cohort <- "COAD"
dir.data.raw <- file.path(dir.data, cohort, "raw/")
dir.data.processed <- file.path(dir.data, cohort, "processed/")

# Results folder
dir.results <- file.path(dir.base, "results/real_data", cohort)

load(file.path(dir.data.processed, "COAD_three_omics_top_2000.rda"))
```

## Sensitivity analysis

```{r eval = F}
size <- run_different_seed(tcga_coad, 
                           status = tcga_coad_clinical$OS, 
                           time = tcga_coad_clinical$OS.time,
                           rep = 10)
```

```{r eval = F}
write_csv(
  size,
  file.path(dir.results, "COAD_sens_analysis.csv")
)
save(
  size,
  file = file.path(dir.results, "COAD_sens_analysis.rda")
)
```

### Model Size

```{r echo = F}
load(file.path(dir.results, "COAD_sens_analysis.rda"))
size_long <- pivot_longer(size, values_to = "Size", names_to = "Data", cols = c("gene", "methy", "mirna"))
size_long$Data <- ifelse(size_long$Data == "gene", "Gene",  ifelse(
  size_long$Data == "methy", "Methyl", "miRNA"
))
g1_coad <- ggboxplot(
  size_long,
  x = "Data",
  y = "Size",
  ylab = "Model Size",
  xlab = "Omics",
  fill = "method",
  palette = "jco",
  title = "TCGA-COAD"
) + theme_bw() + 
  theme(legend.title = element_blank(), legend.position = "bottom") + 
  scale_fill_discrete(labels = c("MRF-IMD-filter", "MRF-IMD-mixture", "MRF-IMD-trans")) +
  geom_vline(xintercept = c(1.5,2.5), 
                 linetype = "dashed", color = "grey30")
g1_coad
```

```{r echo = F}
size2 <- size %>%
  mutate(run = paste(method, seed, sep = "_"))

# extract into three named lists
sel_genes <- size2 %>%
  transmute(run, genes = map(var_selected, ~ paste0("gene_", .x[[1]]))) %>%
  { set_names(.$genes, .$run) }

sel_methy <- size2 %>%
  transmute(run, methy = map(var_selected, ~ paste0("methy_", .x[[2]]))) %>%
  { set_names(.$methy, .$run) }

sel_mirna <- size2 %>%
  transmute(run, mirna = map(var_selected, ~ paste0("mirna_", .x[[3]]))) %>%
  { set_names(.$mirna, .$run) }

size_summ <- size %>% 
  group_by(method) %>% 
  dplyr::summarise_at(vars(gene, methy, mirna, logrank_p), list(mean = mean, sd = sd, median = median)) %>%
  dplyr::mutate(Method = method,
                Gene = paste0(round(gene_mean, 0), " (", round(gene_sd, 2), ")"),
                Methyl = paste0(round(methy_mean, 0), " (", round(methy_sd, 2), ")"),
                miRNA = paste0(round(mirna_mean, 0), " (", round(mirna_sd, 2), ")"),
                "Median logrank -log10(p)" = round(-log10(logrank_p_median), 2),
                .keep = "none")
```

### Jaccard Index

```{r echo = F}
overlap_mat_fn <- function(sel_sets){
  runs <- names(sel_sets)
  n    <- length(runs)
  ol_mat <- matrix(NA, nrow = n, ncol = n,
                  dimnames = list(runs, runs))
  for (i in seq_len(n)) {
    for (j in seq_len(n)) {
      ol_mat[i, j] <- overlap(sel_sets[[runs[i]]],
                               sel_sets[[runs[j]]])
    }
  }
  ol_mat
}
```

```{r echo = F}
overlap_mat_gene <- overlap_mat_fn(sel_genes)
overlap_mat_methy <- overlap_mat_fn(sel_methy)
overlap_mat_mirna <- overlap_mat_fn(sel_mirna)
overlap_list <- list(
  gene = overlap_mat_gene,
  methy = overlap_mat_methy,
  mirna = overlap_mat_mirna
)

df_overlap <- plyr::ldply(
  names(overlap_list),
  .fun = function(ls) {
    tbl <- as.table(overlap_list[[ls]])
    df_overlap <- as.data.frame(tbl)

    df_overlap <- df_overlap %>% 
      dplyr::rename(
        Run1    = Var1,
        Run2    = Var2,
        Overlap = Freq
      )
    df_overlap %>%
      mutate(
        Method1 = sub("_.*", "", Run1),
        Method2 = sub("_.*", "", Run2)
      ) %>%
      # only keep pairs where both runs use the _same_ method
      filter(Method1 == Method2 & Run1 != Run2) %>%
      mutate(Method = Method1,
             Data = ls)
  }
)

ol_summary <- df_overlap %>%
  group_by(Method, Data) %>%
  dplyr::summarize(
    mean_O   = mean(Overlap),
    sd_O     = sd(Overlap),
    n_pairs  = n(),
    # tâ€based 95% CI
    CI_low   = mean_O + qt(0.025, n_pairs-1)*sd_O/sqrt(n_pairs),
    CI_high  = mean_O + qt(0.975, n_pairs-1)*sd_O/sqrt(n_pairs)
  ) %>% 
  mutate(Method = Method,
         Overlap = paste0(round(mean_O, 2), " (", round(CI_low, 2),",", round(CI_high, 2), ")"), .keep = "none")

df_coad <- left_join(size_summ, ol_summary)
```

```{r echo = F}
df_overlap$Data <- ifelse(df_overlap$Data == "gene", "Gene",  ifelse(
  df_overlap$Data == "methy", "Methyl", "miRNA"
))
g2_coad <- ggboxplot(
  df_overlap,
  x = "Data",
  y = "Overlap",
  ylab = "Overlap Coefficient",
  xlab = "Omics",
  fill = "Method1",
  palette = "jco"
  # title = "TCGA-BRCA"
) + theme_bw() + 
  ylim(c(0,1)) +
  theme(legend.title = element_blank(), legend.position = "bottom") + 
  scale_fill_discrete(labels = c("MRF-IMD-filter", "MRF-IMD-mixture", "MRF-IMD-trans")) +
  geom_vline(xintercept = c(1.5,2.5), 
                 linetype = "dashed", color = "grey30")

g2_coad
```

```{r}
g1_coad + g2_coad  +
  plot_layout(guides = "collect")  &
  theme(legend.position = "top")

ggsave(
  file = file.path(dir.results, "COAD_sens_boxplot.pdf"),
  width = 8, height = 4
)
```


## Train Models

### MRF-IMD-mixture

```{r eval = F}
seed <- 136
mod_coad <- mrf3_init(tcga_coad, seed = seed, scale = F, 
                           connect_list = list( c("mirna", "gene"), c("mirna", "methy")))
mod_coad_vs <- mrf3_vs(mod_coad, dat.list = tcga_coad, method= "mixture")
# gene 139 methy 107 mirna 18
```

### SPLS, PMDCCA, RGCCA

```{r}
mod_spls <- mixOmics::block.spls(
  X = tcga_coad,
  indY = 3,
  ncomp = 10,
  keepX  = list(
    gene = rep(139, 5),
    methy = rep(107, 5),
    mirna = rep(18, 5)
  ) 
)

mod_pmd <- PMA::MultiCCA(
  tcga_coad,
  ncomponents  = 5
)

connection <- diag(1,3)
connection[1,3] <- connection[3,1] <- 1
connection[3,2] <- connection[2,3] <- 1
diag(connection) <- 0
mod_rgcca <- rgcca(
  tcga_coad,
  connection = connection,
  ncomp = 5,
  sparsity = 0.1
)
```

```{r eval = F}
save(
  mod_coad,
  mod_coad_vs,
  mod_spls,
  mod_pmd, 
  mod_rgcca,
  file = file.path(dir.results, "COAD_MRF_mod.rda")
)
```

## Pathway analysis

### MRF

```{r echo = F}
load(file.path(dir.results, "COAD_MRF_mod.rda"))
g3_coad <- plot_weights(mod_coad_vs$weights, labels = c("Gene", "Methyl", "miRNA"))
g3_coad
```

```{r eval = F}
ora_results_c2cp <- ORA(colnames(mod_coad_vs$dat.list$gene),
                        pathway = "c2.cp", 
                        minGSSize = 2, 
                        maxGSSize = 1000)
ora_results_h <- ORA(colnames(mod_coad_vs$dat.list$gene),
                     pathway = "H", 
                     minGSSize = 2, 
                     maxGSSize = 1000)
ora_results_go <- ORA(colnames(mod_coad_vs$dat.list$gene), 
                      pathway = "c5.bp", 
                      minGSSize = 2, 
                      maxGSSize = 1000)
```

```{r eval = F, echo = F}
results <- rbind(data.frame(data.frame(ora_results_c2cp@result), 
                            category = rep("Canonical", nrow(data.frame(ora_results_c2cp@result)))),
                  data.frame(data.frame(ora_results_go@result), 
                            category = rep("GO", nrow(data.frame(ora_results_go@result)))),
                 data.frame(data.frame(ora_results_h@result), 
                            category = rep("Hallmark", nrow(data.frame(ora_results_h@result)))))

results_sig <- results %>% filter(p.adjust < 0.05)

write_csv(
  results,
  file = file.path(dir.results, "COAD_pathway_analysis.csv")
)

write_csv(
  results_sig,
  file = file.path(dir.results, "COAD_pathway_analysis_sig_results.csv")
)
```

```{r fig.height=8, fig.width=15, echo=FALSE}
results_coad <- read_csv(
  file.path(dir.results, "COAD_pathway_analysis.csv"),
  show_col_types = F
)
g4_coad <- plot_pathway(results_coad, ylim = 1e-9, padj = 0.05) + 
  ggtitle("TCGA-COAD")
g4_coad
```

### SPLS

```{r eval = F}
ora_results_c2cp <- ORA(names(mod_spls$loadings$gene[,1])[mod_spls$loadings$gene[,1] != 0],
                        pathway = "c2.cp", 
                        minGSSize = 2, 
                        maxGSSize = 1000)
ora_results_h <- ORA(names(mod_spls$loadings$gene[,1])[mod_spls$loadings$gene[,1] != 0],
                     pathway = "H", 
                     minGSSize = 2, 
                     maxGSSize = 1000)
ora_results_go <- ORA(names(mod_spls$loadings$gene[,1])[mod_spls$loadings$gene[,1] != 0], 
                      pathway = "c5.bp", 
                      minGSSize = 2, 
                      maxGSSize = 1000)
```

```{r eval = F, echo = F}
results <- rbind(data.frame(data.frame(ora_results_c2cp@result), 
                            category = rep("Canonical", nrow(data.frame(ora_results_c2cp@result)))),
                  data.frame(data.frame(ora_results_go@result), 
                            category = rep("GO", nrow(data.frame(ora_results_go@result)))),
                 data.frame(data.frame(ora_results_h@result), 
                            category = rep("Hallmark", nrow(data.frame(ora_results_h@result)))))

results_sig <- results %>% filter(p.adjust < 0.05)

write_csv(
  results,
  file = file.path(dir.results, "COAD_pathway_analysis_spls.csv")
)

write_csv(
  results_sig,
  file = file.path(dir.results, "COAD_pathway_analysis_sig_results_spls.csv")
)
```

### PMDCCA

```{r eval = F}
ora_results_c2cp <- ORA(colnames(tcga_coad$gene)[mod_pmd$ws[[1]][,1] != 0],
                        pathway = "c2.cp", 
                        minGSSize = 2, 
                        maxGSSize = 1000)
ora_results_h <- ORA(colnames(tcga_coad$gene)[mod_pmd$ws[[1]][,1] != 0],
                     pathway = "H", 
                     minGSSize = 2, 
                     maxGSSize = 1000)
ora_results_go <- ORA(colnames(tcga_coad$gene)[mod_pmd$ws[[1]][,1] != 0], 
                      pathway = "c5.bp", 
                      minGSSize = 2, 
                      maxGSSize = 1000)
```

```{r eval = F, echo = F}
results <- rbind(data.frame(data.frame(ora_results_c2cp@result), 
                            category = rep("Canonical", nrow(data.frame(ora_results_c2cp@result)))),
                  data.frame(data.frame(ora_results_go@result), 
                            category = rep("GO", nrow(data.frame(ora_results_go@result)))),
                 data.frame(data.frame(ora_results_h@result), 
                            category = rep("Hallmark", nrow(data.frame(ora_results_h@result)))))

results_sig <- results %>% filter(p.adjust < 0.05)

write_csv(
  results,
  file = file.path(dir.results, "COAD_pathway_analysis_pmd.csv")
)

write_csv(
  results_sig,
  file = file.path(dir.results, "COAD_pathway_analysis_sig_results_pmd.csv")
)
```

### RGCCA

```{r eval = F}
ora_results_c2cp <- ORA(names(mod_rgcca$a$gene[,1])[mod_rgcca$a$gene[,1] != 0],
                        pathway = "c2.cp", 
                        minGSSize = 2, 
                        maxGSSize = 1000)
ora_results_h <- ORA(names(mod_rgcca$a$gene[,1])[mod_rgcca$a$gene[,1] != 0],
                     pathway = "H", 
                     minGSSize = 2, 
                     maxGSSize = 1000)
ora_results_go <- ORA(names(mod_rgcca$a$gene[,1])[mod_rgcca$a$gene[,1] != 0],
                      pathway = "c5.bp", 
                      minGSSize = 2, 
                      maxGSSize = 1000)
```

```{r eval = F, echo = F}
results <- rbind(data.frame(data.frame(ora_results_c2cp@result), 
                            category = rep("Canonical", nrow(data.frame(ora_results_c2cp@result)))),
                  data.frame(data.frame(ora_results_go@result), 
                            category = rep("GO", nrow(data.frame(ora_results_go@result)))),
                 data.frame(data.frame(ora_results_h@result), 
                            category = rep("Hallmark", nrow(data.frame(ora_results_h@result)))))

results_sig <- results %>% filter(p.adjust < 0.05)

write_csv(
  results,
  file = file.path(dir.results, "COAD_pathway_analysis_rgcca.csv")
)

write_csv(
  results_sig,
  file = file.path(dir.results, "COAD_pathway_analysis_sig_results_rgcca.csv")
)
```

```{r fig.width = 12, fig.height=12}
results_coad <- read_csv(
  file = file.path(dir.results, "COAD_pathway_analysis_sig_results.csv")
)
results_coad_spls <- read_csv(
  file = file.path(dir.results, "COAD_pathway_analysis_sig_results_spls.csv")
)
results_coad_pmd <- read_csv(
  file = file.path(dir.results, "COAD_pathway_analysis_sig_results_pmd.csv")
)
results_coad_rgcca <- read_csv(
  file = file.path(dir.results, "COAD_pathway_analysis_sig_results_rgcca.csv")
)

ggvenn::ggvenn(
  list("MRF-IMD" = results_coad$ID,
       "SPLS" = results_coad_spls$ID,
       "PMDCCA" = results_coad_pmd$ID,
       "RGCCA" = results_coad_rgcca$ID)
) + ggtitle("TCGA-COAD")
ggsave(
  file.path(dir.results, "COAD_venn_plot.pdf"),
  width = 12,
  height = 10
)
```

## Survival analysis and KM plot

```{r eval = F}
nmf_mod <- IntNMF::nmf.mnnals(
  tcga_coad %>% purrr::map(., ~as.matrix(.)), 2
)

dat_pos_spls <- purrr::map(
    mod_spls$variates, ~{
      if(!all(. > 0)) {
        m <- abs(min(.))
        . <- pmax(. + m, 0)
        as.matrix(./max(.))
      }
    }
  )

dat_pos_spls2 <- plyr::llply(
  c("gene", "methy", "mirna"),
  .fun = function(data) {
    tcga_coad[[data]][,mod_spls$loadings[[data]][,1] != 0] %>% as.matrix
  }
)
names(dat_pos_spls2) <- c("gene", "methy", "mirna")

nmf_mod_spls <- IntNMF::nmf.mnnals(
  dat_pos_spls, 2
)

nmf_mod_spls2 <- IntNMF::nmf.mnnals(
  dat_pos_spls2, 2
)

dat_pos_pmd <- plyr::llply(
  c("gene", "methy", "mirna"),
  .fun = function(data) {
    if(data == "gene") i <- 1
    if(data == "methy") i <- 2
    if(data == "mirna") i <- 3
    d <- as.matrix(tcga_coad[[data]]) %*% mod_pmd$ws[[i]]
    m <- abs(min(d))
    d <- pmax(d + m, 0)
    as.matrix(d/max(d))
  }
)
names(dat_pos_pmd) <- c("gene", "methy", "mirna")

dat_pos_pmd2 <- plyr::llply(
  c("gene", "methy", "mirna"),
  .fun = function(data) {
    if(data == "gene") i <- 1
    if(data == "methy") i <- 2
    if(data == "mirna") i <- 3
    tcga_coad[[data]][,mod_pmd$ws[[i]][,1] != 0] %>% as.matrix
  }
)
names(dat_pos_spls2) <- c("gene", "methy", "mirna")

nmf_mod_pmd <- IntNMF::nmf.mnnals(
  dat_pos_pmd, 2
)

nmf_mod_pmd2 <- IntNMF::nmf.mnnals(
  dat_pos_pmd2, 2
)

dat_pos_rgcca <- purrr::map(
    mod_rgcca$Y, ~{
      if(!all(. > 0)) {
        m <- abs(min(.))
        . <- pmax(. + m, 0)
        as.matrix(./max(.))
      }
    }
  )

dat_pos_rgcca2 <- plyr::llply(
  c("gene", "methy", "mirna"),
  .fun = function(data) {
    tcga_coad[[data]][,mod_rgcca$a[[data]][,1] != 0] %>% as.matrix
  }
)
names(dat_pos_rgcca2) <- c("gene", "methy", "mirna")

nmf_mod_rgcca <- IntNMF::nmf.mnnals(
  dat_pos_rgcca, 2
)

nmf_mod_rgcca2 <- IntNMF::nmf.mnnals(
  dat_pos_rgcca2, 2
)

nmf_mod_mrf <- IntNMF::nmf.mnnals(
  mod_coad_vs$dat.list %>% purrr::map(., ~as.matrix(.)), 2
)

save(nmf_mod, 
     nmf_mod_spls, nmf_mod_spls2, 
     nmf_mod_pmd, nmf_mod_pmd2, 
     dat_pos_rgcca, dat_pos_rgcca2, 
     nmf_mod_mrf, file = file.path(dir.results, "NMF_all_var_spls_mod.rda"))
```

```{r fig.width=16, fig.height=6}
load(file.path(dir.results, "NMF_all_var_spls_mod.rda"))
k1 <- KM_plot(factor(nmf_mod$clusters), "OS.time", "OS", tcga_coad_clinical, title = "All Variables")
k2 <- KM_plot(factor(nmf_mod_spls$clusters), "OS.time", "OS", tcga_coad_clinical,
              title = "SPLS First 5 Components") 
k3 <- KM_plot(factor(nmf_mod_mrf$clusters), "OS.time", "OS", 
              tcga_coad_clinical, title = "MRF-IMD Selected Variables") 
g7_coad <- k1$plot + k2$plot + k3$plot + 
  plot_layout(ncol = 3) + 
  plot_annotation(title = "TCGA-COAD",
                  theme =  theme(plot.title = element_text(face = "bold", size = 14)))
g7_coad
```

```{r}
logrank_p <- function(clusters, time, status) {
  surv_obj <- Surv(time, status)
  lr       <- survdiff(surv_obj ~ factor(clusters))
  1 - pchisq(lr$chisq, df = length(lr$n) - 1)
}

logrank_p_df <- plyr::ldply(
  c("All", "SPLS", "PMDCCA", "RGCCA", "MRF-IMD"),
  .fun = function(method) {
    if (method == "All") {
      return(data.frame(
        Method    = "all",
        logrank_p = logrank_p(
          nmf_mod$clusters,
          tcga_coad_clinical$OS.time,
          tcga_coad_clinical$OS
        )
      ))
    } else if (method == "SPLS") {
      return(data.frame(
        Method    = c("SPLS - 5 comps", "SPLS - selected variables"),
        logrank_p = c(
          logrank_p(
            nmf_mod_spls$clusters,
            tcga_coad_clinical$OS.time,
            tcga_coad_clinical$OS
          ),
          logrank_p(
            nmf_mod_spls2$clusters,
            tcga_coad_clinical$OS.time,
            tcga_coad_clinical$OS
          )
        )
      ))
    } else if (method == "PMDCCA") {
      return(data.frame(
        Method    = c("PMDCCA - 5 comps", "PMDCCA - selected variables"),
        logrank_p = c(
          logrank_p(
            nmf_mod_pmd$clusters,
            tcga_coad_clinical$OS.time,
            tcga_coad_clinical$OS
          ),
          logrank_p(
            nmf_mod_pmd2$clusters,
            tcga_coad_clinical$OS.time,
            tcga_coad_clinical$OS
          )
        )
      ))
    } else if (method == "RGCCA") {
      return(data.frame(
        Method    = c("RGCCA - 5 comps", "RGCCA - selected variables"),
        logrank_p = c(
          logrank_p(
            nmf_mod_rgcca$clusters,
            tcga_coad_clinical$OS.time,
            tcga_coad_clinical$OS
          ),
          logrank_p(
            nmf_mod_rgcca2$clusters,
            tcga_coad_clinical$OS.time,
            tcga_coad_clinical$OS
          )
        )
      ))
    } else if (method == "MRF-IMD") {
      return(data.frame(
        Method    = paste0("MRF-IMD-",size_summ$Method),
        logrank_p = 10^(-size_summ$`Median logrank -log10(p)`)
        )
      )
    } else {
      stop("Unknown method: ", method)
    }
  }
)
logrank_p_df
```

# Combine plot

## Variable weights

```{r fig.height=8, fig.width=12}
g3_brca_titled <- annotate_figure(
  g3_brca,
  top = text_grob("TCGA-BRCA", face = "bold", size = 14)
)

g3_coad_titled <- annotate_figure(
  g3_coad,
  top = text_grob("TCGA-COAD", face = "bold", size = 14)
)

final <- ggarrange(
  g3_brca_titled,
  g3_coad_titled,
  ncol = 1,
  heights = c(1, 1)
)
final

ggsave(
  file.path(dir.results, "../plot/TCGA_BRCA_COAD_var_weights.pdf"),
  width = 15,
  height = 10
)
```

## Pathway analysis

```{r fig.height=20, fig.width=20}
g4_brca + g4_coad + 
  plot_layout(ncol = 1)

ggsave(
  file.path(dir.results, "../plot/TCGA_BRCA_COAD_pathway_analysis.pdf"),
  width = 15,
  height = 18
)
```

```{r}
pimd_brca <- pairwise_imd(
  mod_brca_vs, all_var = F
)
mat <- pimd_brca$adj_var_mat
diag(mat) <- 0
plot_circos(mat, names.list = pimd_brca$var_use, cut.off = 0.01)
```

```{r}
top5_vars <- mod_brca_vs$weights %>% 
  purrr::map(., ~names(sort(., decreasing = T)[1:5]))
top5_vars <- unlist(top5_vars, use.names = F)
top5_vars_ls <- plyr::llply(
  top5_vars,
  .fun = function(var) {
    if(grepl("^cg" ,var)) {
      mat0 <- mat[,!grepl("^cg", colnames(mat))]
    } else if (grepl("^MIMAT" ,var)) {
      mat0 <- mat[,!grepl("^MIMAT", colnames(mat))]
    } else {
      mat0 <- mat[,grepl("^MIMAT|^cg", colnames(mat))]
    }
    sort(mat0[var,], decreasing = T)[1:10]
  }
)
names(top5_vars_ls) <- top5_vars
```

```{r}
top20_vars <- mod_brca_vs$weights %>% 
  purrr::map(., ~names(sort(., decreasing = T)[1:20]))
mat0 <- mat[unlist(top20_vars),unlist(top20_vars)]
plyr::l_ply(
  names(top20_vars),
  .fun = function(dat) {
    mat0[top20_vars[[dat]], top20_vars[[dat]]] <<- 0
  }
)

plot_circos(mat0, names.list = top20_vars, cut.off = 0.01)
```


```{r}
pimd_coad <- pairwise_imd(
  mod_coad_vs, all_var = F
)
```


